stages:
  - notify

# âœ… Merge Request ë°œìƒ ì‹œ Mattermostë¡œ ì•Œë¦¼ ì „ì†¡
notify_mattermost:
  stage: notify
  tags: 
    - docker
    - runner
    - gitlab
  script:
    - apt-get update && apt-get install -y curl jq
    - >
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then 
        JSON_PAYLOAD=$(jq -n \
          --arg project "$CI_PROJECT_NAME" \
          --arg author "$GITLAB_USER_LOGIN" \
          --arg branch "$CI_COMMIT_REF_NAME" \
          --arg title "${CI_MERGE_REQUEST_TITLE:-"ì œëª© ì—†ìŒ"}" \
          --arg url "$CI_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID" \
          '{
            text: "ğŸ”€ *ìƒˆë¡œìš´ Merge Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!* ğŸ‰\n
            **í”„ë¡œì íŠ¸:** \($project)\n
            **ì‘ì„±ì:** \($author)\n
            **ë¸Œëœì¹˜:** \($branch)\n
            **MR ì œëª©:** \($title)\n
            [**Merge Request ë³´ê¸°**](\($url))"
          }')

        curl -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" https://meeting.ssafy.com/hooks/9ecrs1m8ybbtfpa5dxsms8n4zo
      else
        echo "âŒ MR ì •ë³´ ì—†ìŒ"
      fi

# âœ… ì´ìŠˆ ë°œìƒ ì‹œ Mattermostë¡œ ì•Œë¦¼ ì „ì†¡
notify_issue:
  stage: notify
  tags:
    - docker
    - runner
    - gitlab
  script:
    - apt-get update && apt-get install -y curl jq
    - >
      if [ -n "$CI_COMMIT_MESSAGE" ]; then 
        JSON_PAYLOAD=$(jq -n \
          --arg project "$CI_PROJECT_NAME" \
          --arg author "$GITLAB_USER_LOGIN" \
          --arg message "${CI_COMMIT_MESSAGE:-"ì œëª© ì—†ìŒ"}" \
          --arg url "$CI_PROJECT_URL/-/issues/$CI_JOB_ID" \
          '{
            text: "ğŸ“Œ *ìƒˆë¡œìš´ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!* ğŸ“\n
            **í”„ë¡œì íŠ¸:** \($project)\n
            **ì‘ì„±ì:** \($author)\n
            **ì´ìŠˆ ì œëª©:** \($message)\n
            [**ì´ìŠˆ ë³´ê¸°**](\($url))"
          }')

        curl -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" https://meeting.ssafy.com/hooks/9ecrs1m8ybbtfpa5dxsms8n4zo
      else
        echo "âŒ ì´ìŠˆ ì •ë³´ ì—†ìŒ"
      fi
