pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR = "${WORKSPACE}"
  }

  stages {
    stage('Secret 파일 다운로드') {
      steps {
        withCredentials([
          file(credentialsId: 'compose-env', variable: 'COMPOSE_ENV'),
          file(credentialsId: 'spring-secrets', variable: 'SPRING_SECRETS'),
          file(credentialsId: 'frontend-env', variable: 'FRONTEND_ENV')
        ]) {
          sh '''
            cp "$COMPOSE_ENV" .env
            cp "$SPRING_SECRETS" secrets.properties
            cp "$FRONTEND_ENV" frontend/.env
          '''
        }
      }
    }

    stage('GitLab 연동 확인') {
      steps {
        echo "✅ GitLab 소스 코드 정상 연동 완료!"
      }
    }

    stage('프론트엔드 빌드') {
      steps {
        echo "🛠️ 프론트엔드 빌드 시작"
        dir('frontend') {
          sh '''
            npm install
            npm run build
          '''
        }
      }
    }

    stage('도커 이미지 빌드 및 변경 서비스만 재시작') {
      steps {
        echo "🚀 변경된 서비스만 빌드 및 재시작 (DB는 중단 없이 유지)"
        sh '''
          docker compose -f infra/docker-compose.yml up -d --build
        '''
      }
    }
  }

  post {
    failure {
      echo '❌ 빌드 실패! 에러 로그를 확인해주세요.'
    }
    success {
      echo '🎉 배포 성공! Letterring 서비스가 자동으로 배포되었습니다.'
    }
  }
}
