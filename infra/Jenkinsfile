pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR = "${WORKSPACE}/infra"
  }

  stages {
    stage('Secret íŒŒì¼ ë‹¤ìš´ë¡œë“œ') {
      steps {
        withCredentials([
          file(credentialsId: 'env-docker-compose', variable: 'ENV_FILE'),
          file(credentialsId: 'spring-secrets', variable: 'SECRETS_FILE'),
          file(credentialsId: 'env-frontend', variable: 'FRONTEND_ENV_FILE')
        ]) {
          sh '''
            cp "$ENV_FILE" infra/.env
            cp "$SECRETS_FILE" backend/src/main/resources/secrets.properties
            cp "$FRONTEND_ENV_FILE" frontend/.env
          '''
        }
      }
    }

    stage('GitLab ì—°ë™ í™•ì¸') {
      steps {
        echo "âœ… GitLab ì†ŒìŠ¤ ì½”ë“œ ì •ìƒ ì—°ë™ ì™„ë£Œ!"
      }
    }

    stage('í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ') {
      steps {
        echo "ğŸ› ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
        dir('frontend') {
          sh '''
            echo "ğŸ§¹ ì´ì „ ìºì‹œ ì œê±°"
            rm -rf node_modules dist

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (npm ci)"
            npm ci --no-optional

            echo "ğŸ› ï¸ Rollup ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ìˆ˜ë™ ì„¤ì¹˜"
            npm install @rollup/rollup-linux-x64-gnu --save-dev

            echo "ğŸ—ï¸ Vite ë¹Œë“œ ì‹œì‘"
            npm run build || {
              echo "âŒ Vite ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            }

            echo "ğŸ“ dist ì •ìƒ ìƒì„± ì—¬ë¶€ í™•ì¸"
            [ -d dist ] || {
              echo "âŒ dist ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¹Œë“œ ì‹¤íŒ¨!"
              exit 1
            }
          '''
        }
      }
    }

    stage('í”„ë¡ íŠ¸ distë¥¼ EC2 ê³µìœ  ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬') {
      steps {
        echo "ğŸ“ distë¥¼ /home/ubuntu/nginx/html ë¡œ ë³µì‚¬"
        sh '''
          echo "ğŸ“ í˜„ì¬ ê²½ë¡œ: $(pwd)"
          echo "ğŸ“‚ frontend/dist íŒŒì¼ ëª©ë¡:"
          ls -al frontend/dist || {
            echo "âŒ dist ë””ë ‰í† ë¦¬ ì—†ìŒ"
            exit 1
          }

          echo "ğŸ“‚ /home/ubuntu/nginx/html ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)"
          mkdir -p /home/ubuntu/nginx/html || {
            echo "âŒ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨"
            exit 1
          }

          echo "ğŸ“¦ dist íŒŒì¼ ë³µì‚¬ ì‹œì‘"
          cp -r frontend/dist/* /home/ubuntu/nginx/html/ || {
            echo "âŒ dist ë³µì‚¬ ì‹¤íŒ¨"
            exit 1
          }

          echo "ğŸ” ê¶Œí•œ ì„¤ì • ì¤‘..."
          chmod -R 755 /home/ubuntu/nginx/html

          echo "ğŸ“‚ ë³µì‚¬ ì™„ë£Œ í›„ íŒŒì¼ ëª©ë¡:"
          ls -al /home/ubuntu/nginx/html || {
            echo "âŒ ë³µì‚¬ í›„ì—ë„ html ê²½ë¡œê°€ ë¹„ì–´ ìˆìŒ"
            exit 1
          }
        '''
      }
    }

    stage('ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë³€ê²½ ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘') {
      steps {
        echo "ğŸš€ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ ë° ì¬ì‹œì‘ (DBëŠ” ì¤‘ë‹¨ ì—†ì´ ìœ ì§€)"
        sh '''
          docker compose -f infra/docker-compose.yml build --no-cache
          docker compose -f infra/docker-compose.yml up -d
        '''
      }
    }
  }

  post {
    failure {
      echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨! ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
    }
    success {
      echo 'ğŸ‰ ë°°í¬ ì„±ê³µ! Letterring ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.'
    }
  }
}
