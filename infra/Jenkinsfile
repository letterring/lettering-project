pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR = "${WORKSPACE}/infra"
  }

  stages {

    // âœ… ë³€ê²½ ê°ì§€
    stage('Git ë³€ê²½ í™•ì¸') {
      steps {
        script {
          def changedFiles = sh(script: "git diff --name-only HEAD~1", returnStdout: true).trim()

          env.DEFAULT_CONF_CHANGED = changedFiles.contains("infra/nginx/conf.d/default.conf") ? "true" : "false"
          env.FRONTEND_CHANGED = changedFiles.contains("frontend/") ? "true" : "false"
          env.BACKEND_CHANGED = changedFiles.contains("backend/") ? "true" : "false"
          env.FASTAPI_CHANGED = changedFiles.contains("ai/") ? "true" : "false"

          echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:\n${changedFiles}"
          echo "ğŸŸ  Nginx default.conf ë³€ê²½ë¨: ${env.DEFAULT_CONF_CHANGED}"
          echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ë¨: ${env.FRONTEND_CHANGED}"
          echo "ğŸ› ï¸ ë°±ì—”ë“œ ë³€ê²½ë¨: ${env.BACKEND_CHANGED}"
          echo "âš¡ FastAPI ë³€ê²½ë¨: ${env.FASTAPI_CHANGED}"
        }
      }
    }

    // ğŸ” í™˜ê²½ ë³€ìˆ˜ ë° secret íŒŒì¼ ë³µì‚¬
    stage('Secret íŒŒì¼ ë‹¤ìš´ë¡œë“œ') {
      steps {
        withCredentials([
          file(credentialsId: 'env-docker-compose', variable: 'ENV_FILE'),
          file(credentialsId: 'spring-secrets', variable: 'SECRETS_FILE'),
          file(credentialsId: 'env-frontend', variable: 'FRONTEND_ENV_FILE')
        ]) {
          sh '''
            cp "$ENV_FILE" infra/.env
            cp "$SECRETS_FILE" backend/src/main/resources/secrets.properties
            cp "$FRONTEND_ENV_FILE" frontend/.env
          '''
        }
      }
    }

    // ğŸ› ï¸ ë°±ì—”ë“œ ë¹Œë“œ
    stage('ë°±ì—”ë“œ JAR ë¹Œë“œ') {
      when {
        expression { env.BACKEND_CHANGED == "true" }
      }
      steps {
        echo "âš™ï¸ ë°±ì—”ë“œ Gradle ë¹Œë“œ ì‹œì‘"
        dir('backend') {
          sh './gradlew build -x test --no-daemon'
        }
      }
    }

    // ğŸ¨ í”„ë¡ íŠ¸ ë¹Œë“œ
    stage('í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ') {
      when {
        expression { env.FRONTEND_CHANGED == "true" }
      }
      steps {
        echo "ğŸ› ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
        dir('frontend') {
          sh '''
            echo "ğŸ§¹ dist ì •ë¦¬"
            rm -rf dist

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
            npm ci --no-optional || exit 1

            echo "ğŸ—ï¸ Vite ë¹Œë“œ"
            npm run build || exit 1

            [ -d dist ] || {
              echo "âŒ dist ë””ë ‰í† ë¦¬ ì—†ìŒ, ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            }
          '''
        }
      }
    }

    // ğŸ³ ë„ì»¤ ë¹Œë“œ ë° ì¬ì‹œì‘
    stage('ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë³€ê²½ ì„œë¹„ìŠ¤ ì¬ì‹œì‘') {
      steps {
        script {
          def buildFlags = ""
          if (env.DEFAULT_CONF_CHANGED == "true" || env.FASTAPI_CHANGED == "true") {
            echo "â™»ï¸ default.conf ë˜ëŠ” FastAPI ë³€ê²½ â†’ --no-cache ì ìš©"
            buildFlags = "--no-cache"
          }

          sh """
            echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
            docker compose -f infra/docker-compose.yml build ${buildFlags}
            docker compose -f infra/docker-compose.yml up -d
          """
        }
      }
    }
  }

  post {
    failure {
      echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨! ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
    }
    success {
      echo 'ğŸ‰ ë°°í¬ ì„±ê³µ! Letterring ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
    }
  }
}
