pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR     = "${WORKSPACE}"
    MYSQL_ROOT_PASSWORD     = credentials('MYSQL_ROOT_PASSWORD')
    MYSQL_DATABASE          = credentials('MYSQL_DATABASE')
    MYSQL_USER              = credentials('MYSQL_USER')
    MYSQL_PASSWORD          = credentials('MYSQL_PASSWORD')
    SPRING_DATASOURCE_URL   = credentials('SPRING_DATASOURCE_URL')
    KAKAO_CLIENT_ID         = credentials('KAKAO_CLIENT_ID')
    KAKAO_CLIENT_SECRET     = credentials('KAKAO_CLIENT_SECRET')
    ALLOWED_ORIGINS         = credentials('ALLOWED_ORIGINS')
    DOMAIN_NAME             = credentials('DOMAIN_NAME')
  }

  stages {
    stage('GitLab 연동 확인') {
      steps {
        echo "✅ GitLab 소스 코드 정상 연동 완료!"
      }
    }

    stage('프론트엔드 빌드') {
      steps {
        echo "🛠️ 프론트엔드 빌드 시작"
        dir('frontend') {
          sh '''
            npm install
            npm run build
          '''
        }
      }
    }

    stage('도커 이미지 빌드 및 변경 서비스만 재시작') {
      steps {
        echo "🚀 변경된 서비스만 빌드 및 재시작 (DB는 중단 없이 유지)"
        sh '''
          docker compose -f infra/docker-compose.yml up -d --build
        '''
      }
    }
  }

  post {
    failure {
      echo '❌ 빌드 실패! 에러 로그를 확인해주세요.'
    }
    success {
      echo '🎉 배포 성공! Letterring 서비스가 자동으로 배포되었습니다.'
    }
  }
}
