pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR = "${WORKSPACE}/infra"
  }

  stages {
    stage('Git ë³€ê²½ í™•ì¸') {
      steps {
        script {
          def changedFiles = sh(script: "git diff --name-only HEAD~1", returnStdout: true).trim()

          // ê¸°ë³¸ ë³€ê²½ ê°ì§€
          env.DEFAULT_CONF_CHANGED = changedFiles.contains("infra/nginx/conf.d/default.conf") ? "true" : "false"
          env.FRONTEND_CHANGED = changedFiles.contains("frontend/") ? "true" : "false"
          env.BACKEND_CHANGED = changedFiles.contains("backend/") ? "true" : "false"
          env.FASTAPI_CHANGED = changedFiles.contains("ai/") ? "true" : "false"

          // Jenkinsfile ë³€ê²½ ì‹œ ì „ì²´ ë¹Œë“œ ê°•ì œ
          if (changedFiles.contains("infra/Jenkinsfile")) {
            echo "ğŸ› ï¸ Jenkinsfile ë³€ê²½ ê°ì§€ â†’ ì „ì²´ ì„œë¹„ìŠ¤ ì¬ë¹Œë“œ ê°•ì œ ì‹¤í–‰í•œë‹¤."
            env.DEFAULT_CONF_CHANGED = "true"
            env.FRONTEND_CHANGED = "true"
            env.BACKEND_CHANGED = "true"
            env.FASTAPI_CHANGED = "true"
          }

          echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:\n${changedFiles}"
          echo "ğŸŸ  Nginx default.conf ë³€ê²½ë¨: ${env.DEFAULT_CONF_CHANGED}"
          echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ë¨: ${env.FRONTEND_CHANGED}"
          echo "ğŸ› ï¸ ë°±ì—”ë“œ ë³€ê²½ë¨: ${env.BACKEND_CHANGED}"
          echo "âš¡ FastAPI ë³€ê²½ë¨: ${env.FASTAPI_CHANGED}"
        }
      }
    }

    stage('Secret íŒŒì¼ ë‹¤ìš´ë¡œë“œ') {
      steps {
        withCredentials([
          file(credentialsId: 'env-docker-compose', variable: 'ENV_FILE'),
          file(credentialsId: 'spring-secrets', variable: 'SECRETS_FILE'),
          file(credentialsId: 'env-frontend', variable: 'FRONTEND_ENV_FILE')
        ]) {
          sh '''
            cp "$ENV_FILE" infra/.env
            cp "$SECRETS_FILE" backend/src/main/resources/secrets.properties
            cp "$FRONTEND_ENV_FILE" frontend/.env
          '''
        }
      }
    }

    stage('ë°±ì—”ë“œ JAR ë¹Œë“œ') {
      when {
        expression { env.BACKEND_CHANGED == "true" }
      }
      steps {
        echo "âš™ï¸ ë°±ì—”ë“œ Gradle ë¹Œë“œ ì‹œì‘"
        dir('backend') {
          sh './gradlew build -x test --no-daemon'
        }
      }
    }

    stage('í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ') {
      when {
        expression { env.FRONTEND_CHANGED == "true" }
      }
      steps {
        echo "ğŸ› ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
        dir('frontend') {
          sh '''
            echo "ğŸ§¹ dist, node_modules ì •ë¦¬"
            rm -rf dist node_modules package-lock.json

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
            export PATH=/usr/local/lib/nodejs/node-v22.13.1/bin:$PATH
            npm install --legacy-peer-deps || exit 1

            echo "ğŸ—ï¸ Vite ë¹Œë“œ"
            npm run build || {
              echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            }

            [ -d dist ] || {
              echo "âŒ dist ë””ë ‰í† ë¦¬ ì—†ìŒ, ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            }
          '''
        }
      }
    }

    stage('ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë³€ê²½ ì„œë¹„ìŠ¤ ì¬ì‹œì‘') {
      steps {
        script {
          def buildFlags = ""
          if (env.DEFAULT_CONF_CHANGED == "true" || env.FASTAPI_CHANGED == "true") {
            echo "â™»ï¸ default.conf ë˜ëŠ” FastAPI ë³€ê²½ â†’ --no-cache ì ìš©"
            buildFlags = "--no-cache"
          }

          // dist ì—†ì„ ê²½ìš° ëŒ€ë¹„
          sh '''
            if [ ! -d frontend/dist ]; then
              echo "âš ï¸ dist í´ë”ê°€ ì—†ì–´ì„œ ë¹ˆ í´ë” ìƒì„±"
              mkdir -p frontend/dist
            fi
          '''

          sh """
            echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
            docker compose -f infra/docker-compose.yml build ${buildFlags}
            docker compose -f infra/docker-compose.yml up -d
          """
        }
      }
    }
  }

  post {
    failure {
      echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨! ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
    }
    success {
      echo 'ğŸ‰ ë°°í¬ ì„±ê³µ! Letterring ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
    }
  }
}
