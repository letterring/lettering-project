pipeline {
  agent any

  environment {
    COMPOSE_PROJECT_DIR = "${WORKSPACE}/infra"
  }

  stages {
    stage('Secret íŒŒì¼ ë‹¤ìš´ë¡œë“œ') {
      steps {
        withCredentials([
          file(credentialsId: 'env-docker-compose', variable: 'ENV_FILE'),
          file(credentialsId: 'spring-secrets', variable: 'SECRETS_FILE'),
          file(credentialsId: 'env-frontend', variable: 'FRONTEND_ENV_FILE')
        ]) {
          sh '''
            cp "$ENV_FILE" infra/.env
            cp "$SECRETS_FILE" backend/src/main/resources/secrets.properties
            cp "$FRONTEND_ENV_FILE" frontend/.env
          '''
        }
      }
    }

    stage('GitLab ì—°ë™ í™•ì¸') {
      steps {
        echo "âœ… GitLab ì†ŒìŠ¤ ì½”ë“œ ì •ìƒ ì—°ë™ ì™„ë£Œ!"
      }
    }

    stage('í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ') {
      steps {
        echo "ğŸ› ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
        dir('frontend') {
          sh '''
            npm install
            npm run build
            cp -r dist/* ../frontend/dist
          '''
        }
      }
    }

    stage('ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë³€ê²½ ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘') {
      steps {
        echo "ğŸš€ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ ë° ì¬ì‹œì‘ (DBëŠ” ì¤‘ë‹¨ ì—†ì´ ìœ ì§€)"
        sh '''
          docker compose -f infra/docker-compose.yml build --no-cache
          docker compose -f infra/docker-compose.yml up -d
        '''
      }
    }
  }

  post {
    failure {
      echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨! ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
    }
    success {
      echo 'ğŸ‰ ë°°í¬ ì„±ê³µ! Letterring ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.'
    }
  }
}
